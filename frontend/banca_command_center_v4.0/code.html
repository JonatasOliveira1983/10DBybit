<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        name="viewport" />
    <title>Banca Command Center v4.0</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#00E0FF", // Cyan/Blue accent
                        gold: "#FFD700",
                        danger: "#FF4D4D",
                        "background-light": "#F8FAFC",
                        "background-dark": "#050505",
                        card: "#121212",
                    },
                    fontFamily: {
                        display: ["Space Grotesk", "sans-serif"],
                        mono: ["JetBrains Mono", "monospace"],
                    },
                    borderRadius: {
                        DEFAULT: "12px",
                    },
                },
            },
        };
    </script>
    <style>
        .gold-glow {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.25);
            border: 1px solid rgba(255, 215, 0, 0.4);
        }

        .neon-border {
            border: 1px solid rgba(0, 224, 255, 0.2);
        }

        .glass {
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(10px);
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .trading-view-placeholder {
            background: linear-gradient(180deg, #0a0a0a 0%, #121212 100%);
        }

        /* [V5.2.5] Discrete Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 3px;
            height: 3px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(0, 224, 255, 0.1);
            border-radius: 10px;
        }

        .custom-scroll:hover::-webkit-scrollbar-thumb {
            background: rgba(0, 224, 255, 0.3);
        }

        /* Layout 70/30 para gráfico e slots - FORÇADO */
        .main-content {
            display: flex;
            flex-direction: column;
            height: calc(100dvh - 160px);
            /* Desconta header (~100px) e footer (~60px) */
            overflow: hidden;
        }

        .chart-container {
            flex: 7;
            /* 70% */
            flex-shrink: 0;
            min-height: 250px;
        }

        .slots-container {
            flex: 3;
            /* 30% */
            flex-shrink: 0;
            overflow-y: auto;
            min-height: 120px;
        }

        /* Responsividade para telas pequenas */
        @media (max-width: 640px) {
            .main-content {
                height: calc(100dvh - 140px);
            }

            .chart-container {
                flex: 6;
                /* 60% em mobile */
                min-height: 180px;
            }

            .slots-container {
                flex: 4;
                /* 40% em mobile */
                min-height: 100px;
            }

            .slot-card {
                padding: 1rem;
            }

            .slot-card h4 {
                font-size: 1rem;
            }

            .header-compact {
                padding: 0.5rem 1rem;
            }

            .header-compact h2 {
                font-size: 1.75rem;
            }

            .header-compact h3 {
                font-size: 1.125rem;
            }
        }

        @media (max-width: 380px) {
            .main-content {
                height: calc(100dvh - 120px);
            }

            .chart-container {
                flex: 5;
                /* 50% em telas muito pequenas */
                min-height: 150px;
            }

            .slots-container {
                flex: 5;
                /* 50% em telas muito pequenas */
            }

            .slot-card {
                padding: 0.75rem;
            }

            .slot-card h4 {
                font-size: 0.875rem;
            }
        }

        /* [V7.0] Clean & Premium Scale */
        html {
            font-size: 16px;
        }

        .slot-card {
            background: linear-gradient(145deg, #121212 0%, #1a1a1a 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slot-card:hover {
            border-color: rgba(0, 224, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Status Colors */
        .color-sniper {
            color: #00E0FF;
        }

        .color-surf {
            color: #10B981;
        }

        .color-gold {
            color: #FFD700;
        }

        /* Touch Optimized Layout */
        header {
            padding-top: env(safe-area-inset-top, 12px);
        }

        nav,
        .fixed.bottom-0 {
            padding-bottom: env(safe-area-inset-bottom, 24px);
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(20px);
        }

        /* Utility for Single Order Focus */
        .single-order-mega {
            grid-column: span 2 / span 2;
        }

        @media (max-width: 640px) {
            .single-order-mega {
                grid-column: span 1 / span 1;
            }

            #slots-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <style>
        body {
            min-height: 100dvh;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen flex flex-col">
    <div class="h-12 w-full"></div>
    <header
        class="px-4 sm:px-6 py-3 sm:py-4 flex flex-col gap-1 sticky top-0 z-50 glass border-b border-white/5 header-compact">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-2 sm:gap-3">
                <img alt="1Crypten Space Logo" class="w-6 h-6 sm:w-8 sm:h-8 rounded-full"
                    src="https://lh3.googleusercontent.com/aida-public/AB6AXuCrElXfwTQYdlHIDMqBLkvvZogtrD5gjv8NKco436cd_SFd7VMRFc9M0ou3WESlcjnnp8bwcBWeM7Wj0tUgaqHLBqmrZ_MZcjpeNXu-IO1V_847ENtkeVZ11b1QY-QEMkivlupE5zgF8nvVOiInluNdul2Sa09mvVQSHxqAFJ4gCjPQWw4BfKxnt6qc9Izpcj2ifXT7_TsZ-IheJ3edmJZ28cfUAPtDOKe7EKjd9Tb0QervwUmH3hbqPvZSvpvojeRC5ePj1fu_EFg" />
                <h1 class="text-[10px] sm:text-xs font-mono tracking-widest uppercase opacity-50">Banca Command v4.9.4.2
                    PWA
                </h1>
            </div>
            <div class="flex items-center gap-1.5 sm:gap-2">
                <span
                    class="text-[8px] sm:text-[10px] font-bold px-1.5 sm:px-2 py-0.5 rounded bg-primary/10 text-primary border border-primary/20">LIVE</span>
                <span class="material-icons-round text-primary text-xs sm:text-sm">sensors</span>
            </div>
        </div>
        <div class="flex justify-between items-end mt-2 sm:mt-4">
            <div>
                <p class="text-[10px] sm:text-xs text-slate-400 font-medium uppercase tracking-tighter">Total Equity</p>
                <h2 id="total-equity" class="text-2xl sm:text-3xl font-bold tracking-tight text-white">$0.00</h2>
            </div>
            <div class="text-right">
                <p class="text-[10px] sm:text-xs text-slate-400 font-medium uppercase tracking-tighter">Risk Level</p>
                <div class="flex items-center gap-1 sm:gap-1.5 justify-end">
                    <span id="risk-dot" class="h-1.5 w-1.5 sm:h-2 sm:w-2 rounded-full bg-slate-500"></span>
                    <h3 id="risk-level" class="text-base sm:text-xl font-mono text-slate-400">0.00%</h3>
                </div>
            </div>
        </div>
    </header>
    <main class="main-content">
        <section
            class="chart-container w-full relative trading-view-placeholder border-b border-white/5 overflow-hidden">
            <div class="absolute inset-0 opacity-20 pointer-events-none">
                <div class="absolute top-1/4 w-full border-t border-dashed border-primary"></div>
                <div class="absolute top-1/2 w-full border-t border-dashed border-danger"></div>
                <div class="absolute bottom-1/4 w-full border-t border-dashed border-gold"></div>
            </div>
            <div class="absolute top-4 left-4 flex gap-4">
                <div class="bg-black/60 px-3 py-1 rounded-md border border-primary/30">
                    <p class="text-[10px] text-primary uppercase font-bold">Entry</p>
                    <p class="text-sm font-mono text-white">64,250.00</p>
                </div>
                <div class="bg-black/60 px-3 py-1 rounded-md border border-danger/30">
                    <p class="text-[10px] text-danger uppercase font-bold">Stop</p>
                    <p class="text-sm font-mono text-white">63,100.00</p>
                </div>
                <div class="bg-black/60 px-3 py-1 rounded-md border border-gold/30">
                    <p class="text-[10px] text-gold uppercase font-bold">Target</p>
                    <p class="text-sm font-mono text-white">68,400.00</p>
                </div>
            </div>
            <svg class="w-full h-full" preserveAspectRatio="none" viewBox="0 0 400 200">
                <path d="M0 150 Q 50 140, 100 160 T 200 120 T 300 80 T 400 40" fill="none" stroke="#00E0FF"
                    stroke-width="2"></path>
                <path d="M0 160 Q 50 155, 100 165 T 200 135 T 300 100 T 400 70" fill="none" stroke="#FFD700"
                    stroke-dasharray="4" stroke-width="1"></path>
            </svg>
            <div class="absolute bottom-4 right-4 flex gap-2">
                <button class="w-8 h-8 rounded-full bg-black/50 flex items-center justify-center text-white"><span
                        class="material-icons-round text-sm">zoom_in</span></button>
                <button class="w-8 h-8 rounded-full bg-black/50 flex items-center justify-center text-white"><span
                        class="material-icons-round text-sm">fullscreen</span></button>
            </div>
        </section>
        <section class="slots-container px-3 sm:px-4 py-3 sm:py-4 custom-scroll">
            <h3 id="slots-header"
                class="text-[10px] sm:text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 sm:mb-4 flex items-center gap-2">
                Active Deployments <span class="h-1 w-1 rounded-full bg-slate-500"></span> 0 Assets
            </h3>
            <div id="slots-list" class="grid grid-cols-2 gap-2 sm:gap-3">
                <!-- Slots dynamic -->
            </div>
        </section>
    </main>
    <section class="fixed bottom-0 left-0 right-0 glass border-t border-white/10 px-6 py-4 pb-8">
        <div class="flex items-center gap-2 mb-2">
            <span class="material-icons-round text-primary text-sm">radio</span>
            <span class="text-[10px] font-bold text-primary uppercase tracking-widest">Captain's Terminal</span>
            <!-- V4.2: Voice Controls -->
            <div class="ml-auto flex gap-2">
                <button id="voice-mic-btn" onclick="startVoiceInput()"
                    class="w-7 h-7 rounded-full bg-primary/20 hover:bg-primary/30 flex items-center justify-center transition"
                    title="Falar com Capitão">
                    <span class="material-icons-round text-primary text-sm">mic</span>
                </button>
            </div>
        </div>
        <div class="bg-black/40 rounded-lg p-3 max-h-24 overflow-y-auto custom-scroll" id="captain-log">
            <div class="flex gap-2 mb-2 last:mb-0">
                <span class="text-slate-500 font-mono text-[10px] shrink-0">--:--</span>
                <p class="text-xs text-slate-300 leading-relaxed font-mono">Aguardando transmissões do Capitão...</p>
            </div>
        </div>
        <!-- V4.2: Quick Command Buttons -->
        <div class="flex gap-2 mt-3 overflow-x-auto pb-1">
            <button onclick="sendQuickCommand('status de risco')"
                class="shrink-0 px-3 py-1.5 rounded-full bg-emerald-500/20 border border-emerald-500/30 text-emerald-400 text-[10px] font-bold uppercase hover:bg-emerald-500/30 transition">
                Status Risco
            </button>
            <button onclick="sendQuickCommand('modo cautela')"
                class="shrink-0 px-3 py-1.5 rounded-full bg-orange-500/20 border border-orange-500/30 text-orange-400 text-[10px] font-bold uppercase hover:bg-orange-500/30 transition">
                Modo Cautela
            </button>
            <button onclick="sendQuickCommand('ciclo')"
                class="shrink-0 px-3 py-1.5 rounded-full bg-primary/20 border border-primary/30 text-primary text-[10px] font-bold uppercase hover:bg-primary/30 transition">
                Progresso Ciclo
            </button>
        </div>
        <div class="mt-4 flex justify-around items-center">
            <a href="/banca/ui" class="flex flex-col items-center gap-1 text-primary">
                <span class="material-icons-round text-[28px]">space_dashboard</span>
                <span class="text-[12px] font-bold uppercase">Banca</span>
            </a>
            <a href="/journey_radar_v4.0/code.html"
                class="flex flex-col items-center gap-1 text-slate-400 hover:text-primary transition">
                <span class="material-icons-round text-[28px]">timeline</span>
                <span class="text-[12px] font-bold uppercase">Radar</span>
            </a>
            <a href="/vault_v4.0/code.html"
                class="flex flex-col items-center gap-1 text-slate-400 hover:text-gold transition">
                <span class="material-icons-round text-[28px]">account_balance_wallet</span>
                <span class="text-[12px] font-bold uppercase">Vault</span>
            </a>
            <a href="/synergy_agent_logs_v4.0/code.html"
                class="flex flex-col items-center gap-1 text-slate-400 hover:text-primary transition">
                <span class="material-icons-round text-[28px]">auto_awesome</span>
                <span class="text-[12px] font-bold uppercase">Logs</span>
            </a>
        </div>
    </section>

    <script>
        const API_BASE = window.location.origin;

        // Fetch logs on load
        async function fetchLogs() {
            try {
                const res = await fetch(`${API_BASE}/api/logs?limit=5`);
                const logs = await res.json();
                const container = document.getElementById('captain-log');
                if (logs && logs.length > 0) {
                    container.innerHTML = logs.map(log => {
                        const time = log.timestamp ? new Date(log.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '--:--';
                        return `<div class="flex gap-2 mb-2 last:mb-0">
                            <span class="text-slate-500 font-mono text-[10px] shrink-0">${time}</span>
                            <p class="text-xs text-slate-300 leading-relaxed font-mono">${log.message || log.text}</p>
                        </div>`;
                    }).join('');
                }
            } catch (e) { console.error(e); }
        }

        // V4.2: Voice Input
        let recognition = null;
        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Reconhecimento de voz não suportado neste navegador.');
                return;
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.interimResults = false;

            const micBtn = document.getElementById('voice-mic-btn');
            micBtn.classList.add('bg-red-500/30');
            micBtn.querySelector('span').textContent = 'mic_off';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                sendQuickCommand(transcript);
            };
            recognition.onend = () => {
                micBtn.classList.remove('bg-red-500/30');
                micBtn.querySelector('span').textContent = 'mic';
            };
            recognition.onerror = () => {
                micBtn.classList.remove('bg-red-500/30');
                micBtn.querySelector('span').textContent = 'mic';
            };
            recognition.start();
        }

        // Send command to Captain
        async function sendQuickCommand(command) {
            try {
                const res = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: command })
                });
                const data = await res.json();
                // Speak response
                if (data.response && 'speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(data.response);
                    utterance.lang = 'pt-BR';
                    speechSynthesis.speak(utterance);
                }
                // Refresh logs
                fetchLogs();
            } catch (e) { console.error(e); }
        }

        // Initial load
        fetchLogs();
        fetchBancaStatus();
        fetchActiveSlots();

        setInterval(fetchLogs, 10000);
        setInterval(fetchBancaStatus, 15000);
        setInterval(fetchActiveSlots, 5000);

        async function fetchBancaStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                const data = await res.json();

                document.getElementById('total-equity').textContent = `$${(data.saldo_total || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
                const risk = (data.risco_real_percent || 0) * 100;
                document.getElementById('risk-level').textContent = `${risk.toFixed(2)}%`;

                const dot = document.getElementById('risk-dot');
                dot.className = "h-2 w-2 rounded-full animate-pulse " + (risk > 10 ? 'bg-danger' : (risk > 5 ? 'bg-orange-400' : 'bg-emerald-500'));
                document.getElementById('risk-level').className = "text-xl font-mono " + (risk > 10 ? 'text-danger' : (risk > 5 ? 'text-orange-400' : 'text-emerald-400'));
            } catch (e) { }
        }

        async function fetchActiveSlots() {
            try {
                const res = await fetch(`${API_BASE}/api/slots`);
                const slots = await res.json();
                const active = slots.filter(s => s.symbol);

                document.getElementById('slots-header').innerHTML = `Active Deployments <span class="h-1 w-1 rounded-full bg-slate-500"></span> ${active.length} Assets`;

                const container = document.getElementById('slots-list');
                if (active.length === 0) {
                    container.innerHTML = `<div class="col-span-2 py-10 text-center opacity-30 uppercase font-bold text-[10px]">Silêncio Radar: Aguardando Sinais</div>`;
                    return;
                }

                container.innerHTML = active.map(s => {
                    const pnl = s.pnl_percent || 0;
                    const pnlClass = pnl >= 0 ? 'text-emerald-400' : 'text-danger';
                    const isZeroRisk = s.status_risco && (s.status_risco.includes('RISK ZERO') || s.status_risco.includes('PROTEGIDO'));
                    const statusClass = s.status_visual ? `status-${s.status_visual.toLowerCase()}` : '';
                    const borderClass = isZeroRisk ? 'border-gold/50 shadow-[0_0_15px_rgba(255,215,0,0.1)]' : 'border-white/5';
                    const side = (s.side || 'BUY').toUpperCase();
                    const sideClass = side === 'BUY' ? 'text-emerald-500' : 'text-danger';

                    return `
                        <div class="slot-card p-5 rounded-2xl border ${borderClass} flex flex-col gap-4 transition-all single-order-mega">
                            <!-- Header: Symbol and Side -->
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <h4 class="font-bold text-white text-xl tracking-tight">${s.symbol}</h4>
                                        <span class="px-2 py-0.5 rounded text-[10px] font-black bg-white/5 ${sideClass} border border-white/10 italic">${side} 50X</span>
                                    </div>
                                    <p class="text-xs ${isZeroRisk ? 'text-gold' : 'text-primary'} font-bold uppercase tracking-widest flex items-center gap-1">
                                        ${isZeroRisk ? '<span class="material-icons-round text-sm">verified</span> RISK ZERO' : '<span class="material-icons-round text-sm">gps_fixed</span> SNIPER ELITE'}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <span class="text-2xl font-mono font-bold ${pnlClass}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}%</span>
                                    <p class="text-[10px] text-slate-500 font-mono">ROI ACUMULADO</p>
                                </div>
                            </div>

                            <!-- Execution Details -->
                            <div class="grid grid-cols-2 gap-4 py-3 border-y border-white/5">
                                <div>
                                    <p class="text-[9px] text-slate-500 uppercase font-bold tracking-tighter">Preço Entrada</p>
                                    <p class="text-sm font-mono text-slate-200">$${(s.entry_price || 0).toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-[9px] text-slate-500 uppercase font-bold tracking-tighter">Stop Loss Ativo</p>
                                    <p class="text-sm font-mono ${isZeroRisk ? 'text-gold' : 'text-danger'}">$${(s.current_stop || 0).toLocaleString()}</p>
                                </div>
                            </div>

                            <!-- PNL Bar -->
                            <div class="space-y-1.5">
                                <div class="flex justify-between items-end">
                                    <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Momentum Fluxo</span>
                                    <span class="text-xs font-mono ${pnlClass}">${pnl.toFixed(1)}%</span>
                                </div>
                                <div class="w-full h-1.5 bg-white/5 rounded-full overflow-hidden">
                                    <div class="h-full ${isZeroRisk ? 'bg-gold shadow-[0_0_8px_#FFD700]' : 'bg-primary shadow-[0_0_8px_#00E0FF]'}" 
                                         style="width: ${Math.min(100, Math.max(5, Math.abs(pnl)))}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) { }
        }
    </script>
</body>

</html>