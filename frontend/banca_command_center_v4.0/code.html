<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        name="viewport" />
    <title>Banca Command Center v4.0</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#00E0FF", // Cyan/Blue accent
                        gold: "#FFD700",
                        danger: "#FF4D4D",
                        "background-light": "#F8FAFC",
                        "background-dark": "#050505",
                        card: "#121212",
                    },
                    fontFamily: {
                        display: ["Space Grotesk", "sans-serif"],
                        mono: ["JetBrains Mono", "monospace"],
                    },
                    borderRadius: {
                        DEFAULT: "12px",
                    },
                },
            },
        };
    </script>
    <style>
        .gold-glow {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.25);
            border: 1px solid rgba(255, 215, 0, 0.4);
        }

        .neon-border {
            border: 1px solid rgba(0, 224, 255, 0.2);
        }

        .glass {
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(10px);
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .trading-view-placeholder {
            background: linear-gradient(180deg, #0a0a0a 0%, #121212 100%);
        }

        /* [V5.2.5] Discrete Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 3px;
            height: 3px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(0, 224, 255, 0.1);
            border-radius: 10px;
        }

        .custom-scroll:hover::-webkit-scrollbar-thumb {
            background: rgba(0, 224, 255, 0.3);
        }

        /* Layout 70/30 para gr√°fico e slots - FOR√áADO */
        .main-content {
            display: flex;
            flex-direction: column;
            height: calc(100dvh - 160px);
            /* Desconta header (~100px) e footer (~60px) */
            overflow: hidden;
        }

        .chart-container {
            flex: 7;
            /* 70% */
            flex-shrink: 0;
            min-height: 250px;
        }

        .slots-container {
            flex: 3;
            /* 30% */
            flex-shrink: 0;
            overflow-y: auto;
            min-height: 120px;
        }

        /* Responsividade para telas pequenas */
        @media (max-width: 640px) {
            .main-content {
                height: calc(100dvh - 140px);
            }

            .chart-container {
                flex: 6;
                /* 60% em mobile */
                min-height: 180px;
            }

            .slots-container {
                flex: 4;
                /* 40% em mobile */
                min-height: 100px;
            }

            .slot-card {
                padding: 1rem;
            }

            .slot-card h4 {
                font-size: 1rem;
            }

            .header-compact {
                padding: 0.5rem 1rem;
            }

            .header-compact h2 {
                font-size: 1.75rem;
            }

            .header-compact h3 {
                font-size: 1.125rem;
            }
        }

        @media (max-width: 380px) {
            .main-content {
                height: calc(100dvh - 120px);
            }

            .chart-container {
                flex: 5;
                /* 50% em telas muito pequenas */
                min-height: 150px;
            }

            .slots-container {
                flex: 5;
                /* 50% em telas muito pequenas */
            }

            .slot-card {
                padding: 0.75rem;
            }

            .slot-card h4 {
                font-size: 0.875rem;
            }
        }

        /* [V7.0] Clean & Premium Scale */
        html {
            font-size: 16px;
        }

        .slot-card {
            background: linear-gradient(145deg, #121212 0%, #1a1a1a 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slot-card:hover {
            border-color: rgba(0, 224, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Status Colors */
        .color-sniper {
            color: #00E0FF;
        }

        .color-surf {
            color: #10B981;
        }

        .color-gold {
            color: #FFD700;
        }

        /* Touch Optimized Layout */
        header {
            padding-top: env(safe-area-inset-top, 12px);
        }

        nav,
        .fixed.bottom-0 {
            padding-bottom: env(safe-area-inset-bottom, 24px);
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(20px);
        }

        /* Utility for Single Order Focus */
        .single-order-mega {
            grid-column: span 2 / span 2;
        }

        @media (max-width: 640px) {
            .single-order-mega {
                grid-column: span 2 / span 2;
            }

            #slots-list {
                grid-template-columns: 1fr;
            }
        }

        /* V5.0 Advanced Sniper UI */
        .gauge-container {
            position: relative;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .gauge-fill {
            height: 100%;
            transition: width 0.5s ease-out;
            background: linear-gradient(90deg, #00E0FF, #FFD700);
            box-shadow: 0 0 10px rgba(0, 224, 255, 0.5);
        }

        .risk-shield-badge {
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            animation: pulse-gold 2s infinite;
        }

        @keyframes pulse-gold {
            0% {
                box-shadow: 0 0 5px rgba(255, 215, 0, 0.4);
            }

            50% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            }

            100% {
                box-shadow: 0 0 5px rgba(255, 215, 0, 0.4);
            }
        }

        .mission-timer {
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 1px;
        }
    </style>
    <style>
        body {
            min-height: 100dvh;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen flex flex-col">
    <div class="h-12 w-full"></div>
    <header
        class="px-4 sm:px-6 py-3 sm:py-4 flex flex-col gap-1 sticky top-0 z-50 glass border-b border-white/5 header-compact">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-2 sm:gap-3">
                <img alt="1Crypten Space Logo" class="w-6 h-6 sm:w-8 sm:h-8 rounded-full"
                    src="https://lh3.googleusercontent.com/aida-public/AB6AXuCrElXfwTQYdlHIDMqBLkvvZogtrD5gjv8NKco436cd_SFd7VMRFc9M0ou3WESlcjnnp8bwcBWeM7Wj0tUgaqHLBqmrZ_MZcjpeNXu-IO1V_847ENtkeVZ11b1QY-QEMkivlupE5zgF8nvVOiInluNdul2Sa09mvVQSHxqAFJ4gCjPQWw4BfKxnt6qc9Izpcj2ifXT7_TsZ-IheJ3edmJZ28cfUAPtDOKe7EKjd9Tb0QervwUmH3hbqPvZSvpvojeRC5ePj1fu_EFg" />
                <h1 class="text-[10px] sm:text-xs font-mono tracking-widest uppercase opacity-50">Banca Command v4.9.4.2
                    PWA
                </h1>
            </div>
            <div class="flex items-center gap-1.5 sm:gap-2">
                <span
                    class="text-[8px] sm:text-[10px] font-bold px-1.5 sm:px-2 py-0.5 rounded bg-primary/10 text-primary border border-primary/20">LIVE</span>
                <!-- V9.0 Cycle Mini Indicator -->
                <span id="cycle-mini"
                    class="text-[8px] sm:text-[10px] font-mono px-1.5 sm:px-2 py-0.5 rounded bg-gold/10 text-gold border border-gold/20">C1:
                    0/10</span>
                <span class="material-icons-round text-primary text-xs sm:text-sm">sensors</span>
            </div>
        </div>
        <div class="flex justify-between items-end mt-2 sm:mt-4">
            <div>
                <p class="text-[10px] sm:text-xs text-slate-400 font-medium uppercase tracking-tighter">Total Equity</p>
                <h2 id="total-equity" class="text-2xl sm:text-3xl font-bold tracking-tight text-white">$0.00</h2>
            </div>
            <div class="text-right">
                <p class="text-[10px] sm:text-xs text-slate-400 font-medium uppercase tracking-tighter">Risk Level</p>
                <div class="flex items-center gap-1 sm:gap-1.5 justify-end">
                    <span id="risk-dot" class="h-1.5 w-1.5 sm:h-2 sm:w-2 rounded-full bg-slate-500"></span>
                    <h3 id="risk-level" class="text-base sm:text-xl font-mono text-slate-400">0.00%</h3>
                </div>
            </div>
        </div>
    </header>
    <main class="main-content">
        <section
            class="chart-container w-full relative trading-view-placeholder border-b border-white/5 overflow-hidden">
            <div class="absolute inset-0 opacity-20 pointer-events-none" id="chart-lines-container">
                <div id="line-entry"
                    class="absolute left-0 w-full border-t border-dashed border-primary transition-all duration-500"
                    style="top: 50%;"></div>
                <div id="line-stop"
                    class="absolute left-0 w-full border-t border-dashed border-danger transition-all duration-500"
                    style="top: 60%;"></div>
                <div id="line-target"
                    class="absolute left-0 w-full border-t border-dashed border-gold transition-all duration-500"
                    style="top: 30%;"></div>
            </div>
            <div class="absolute top-4 left-4 flex gap-4 transition-opacity duration-300" id="chart-labels">
                <div class="bg-black/60 px-3 py-1 rounded-md border border-primary/30">
                    <p class="text-[10px] text-primary uppercase font-bold">Entry</p>
                    <p id="label-entry" class="text-sm font-mono text-white">--</p>
                </div>
                <div class="bg-black/60 px-3 py-1 rounded-md border border-danger/30">
                    <p class="text-[10px] text-danger uppercase font-bold">Stop</p>
                    <p id="label-stop" class="text-sm font-mono text-white">--</p>
                </div>
                <div class="bg-black/60 px-3 py-1 rounded-md border border-gold/30">
                    <p class="text-[10px] text-gold uppercase font-bold">Target</p>
                    <p id="label-target" class="text-sm font-mono text-white">--</p>
                </div>
            </div>
            <svg class="w-full h-full" preserveAspectRatio="none" viewBox="0 0 400 200">
                <path d="M0 150 Q 50 140, 100 160 T 200 120 T 300 80 T 400 40" fill="none" stroke="#00E0FF"
                    stroke-width="2"></path>
                <path d="M0 160 Q 50 155, 100 165 T 200 135 T 300 100 T 400 70" fill="none" stroke="#FFD700"
                    stroke-dasharray="4" stroke-width="1"></path>
            </svg>
            <div class="absolute bottom-4 right-4 flex gap-2">
                <button class="w-8 h-8 rounded-full bg-black/50 flex items-center justify-center text-white"><span
                        class="material-icons-round text-sm">zoom_in</span></button>
                <button class="w-8 h-8 rounded-full bg-black/50 flex items-center justify-center text-white"><span
                        class="material-icons-round text-sm">fullscreen</span></button>
            </div>
        </section>
        <section class="slots-container px-3 sm:px-4 py-3 sm:py-4 custom-scroll">
            <h3 id="slots-header"
                class="text-[10px] sm:text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 sm:mb-4 flex items-center gap-2">
                Active Deployments <span class="h-1 w-1 rounded-full bg-slate-500"></span> 0 Assets
            </h3>
            <div id="slots-list" class="grid grid-cols-2 gap-2 sm:gap-3">
                <!-- Slots dynamic -->
            </div>
        </section>
    </main>
    <section class="fixed bottom-0 left-0 right-0 glass border-t border-white/10 px-6 py-4 pb-8">
        <div class="flex items-center gap-2 mb-2">
            <span class="material-icons-round text-primary text-sm">radio</span>
            <span class="text-[10px] font-bold text-primary uppercase tracking-widest">Captain's Terminal</span>
            <!-- V4.2: Voice Controls -->
            <div class="ml-auto flex gap-2">
                <button id="voice-mic-btn" onclick="startVoiceInput()"
                    class="w-7 h-7 rounded-full bg-primary/20 hover:bg-primary/30 flex items-center justify-center transition"
                    title="Falar com Capit√£o">
                    <span class="material-icons-round text-primary text-sm">mic</span>
                </button>
            </div>
        </div>
        <div class="bg-black/40 rounded-lg p-3 max-h-24 overflow-y-auto custom-scroll" id="captain-log">
            <div class="flex gap-2 mb-2 last:mb-0">
                <span class="text-slate-500 font-mono text-[10px] shrink-0">--:--</span>
                <p class="text-xs text-slate-300 leading-relaxed font-mono">Aguardando transmiss√µes do Capit√£o...</p>
            </div>
        </div>
        <!-- V4.2: Quick Command Buttons -->
        <div class="flex gap-2 mt-3 overflow-x-auto pb-1">
            <button onclick="sendQuickCommand('status de risco')"
                class="shrink-0 px-3 py-1.5 rounded-full bg-emerald-500/20 border border-emerald-500/30 text-emerald-400 text-[10px] font-bold uppercase hover:bg-emerald-500/30 transition">
                Status Risco
            </button>
            <button onclick="sendQuickCommand('modo cautela')"
                class="shrink-0 px-3 py-1.5 rounded-full bg-orange-500/20 border border-orange-500/30 text-orange-400 text-[10px] font-bold uppercase hover:bg-orange-500/30 transition">
                Modo Cautela
            </button>
            <button onclick="sendQuickCommand('ciclo')"
                class="shrink-0 px-3 py-1.5 rounded-full bg-primary/20 border border-primary/30 text-primary text-[10px] font-bold uppercase hover:bg-primary/30 transition">
                Progresso Ciclo
            </button>
        </div>
        <div class="mt-4 flex justify-around items-center">
            <a href="/banca/ui" class="flex flex-col items-center gap-1 text-primary">
                <span class="material-icons-round text-[28px]">space_dashboard</span>
                <span class="text-[12px] font-bold uppercase">Banca</span>
            </a>
            <a href="/journey_radar_v4.0/code.html"
                class="flex flex-col items-center gap-1 text-slate-400 hover:text-primary transition">
                <span class="material-icons-round text-[28px]">timeline</span>
                <span class="text-[12px] font-bold uppercase">Radar</span>
            </a>
            <a href="/vault_v4.0/code.html"
                class="flex flex-col items-center gap-1 text-slate-400 hover:text-gold transition">
                <span class="material-icons-round text-[28px]">account_balance_wallet</span>
                <span class="text-[12px] font-bold uppercase">Vault</span>
            </a>
            <a href="/synergy_agent_logs_v4.0/code.html"
                class="flex flex-col items-center gap-1 text-slate-400 hover:text-primary transition">
                <span class="material-icons-round text-[28px]">auto_awesome</span>
                <span class="text-[12px] font-bold uppercase">Logs</span>
            </a>
        </div>
    </section>

    <script>
        const API_BASE = window.location.origin;

        // Fetch logs on load
        async function fetchLogs() {
            try {
                const res = await fetch(`${API_BASE}/api/logs?limit=5`);
                const logs = await res.json();
                const container = document.getElementById('captain-log');
                if (logs && logs.length > 0) {
                    container.innerHTML = logs.map(log => {
                        const time = log.timestamp ? new Date(log.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '--:--';
                        return `<div class="flex gap-2 mb-2 last:mb-0">
                            <span class="text-slate-500 font-mono text-[10px] shrink-0">${time}</span>
                            <p class="text-xs text-slate-300 leading-relaxed font-mono">${log.message || log.text}</p>
                        </div>`;
                    }).join('');
                }
            } catch (e) { console.error(e); }
        }

        // V4.2: Voice Input
        let recognition = null;
        function startVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Reconhecimento de voz n√£o suportado neste navegador.');
                return;
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.interimResults = false;

            const micBtn = document.getElementById('voice-mic-btn');
            micBtn.classList.add('bg-red-500/30');
            micBtn.querySelector('span').textContent = 'mic_off';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                sendQuickCommand(transcript);
            };
            recognition.onend = () => {
                micBtn.classList.remove('bg-red-500/30');
                micBtn.querySelector('span').textContent = 'mic';
            };
            recognition.onerror = () => {
                micBtn.classList.remove('bg-red-500/30');
                micBtn.querySelector('span').textContent = 'mic';
            };
            recognition.start();
        }

        // Send command to Captain
        async function sendQuickCommand(command) {
            try {
                const res = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: command })
                });
                const data = await res.json();
                // Speak response
                if (data.response && 'speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(data.response);
                    utterance.lang = 'pt-BR';
                    speechSynthesis.speak(utterance);
                }
                // Refresh logs
                fetchLogs();
            } catch (e) { console.error(e); }
        }

        // Initial load
        fetchLogs();
        fetchBancaStatus();
        fetchActiveSlots();

        setInterval(fetchLogs, 10000);
        setInterval(fetchBancaStatus, 15000);
        setInterval(fetchActiveSlots, 5000);

        async function fetchBancaStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                const data = await res.json();

                const displayBalance = data.configured_balance || data.saldo_total || 0;
                document.getElementById('total-equity').textContent = `$${displayBalance.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
                const risk = (data.risco_real_percent || 0) * 100;
                document.getElementById('risk-level').textContent = `${risk.toFixed(2)}%`;

                const dot = document.getElementById('risk-dot');
                dot.className = "h-2 w-2 rounded-full animate-pulse " + (risk > 10 ? 'bg-danger' : (risk > 5 ? 'bg-orange-400' : 'bg-emerald-500'));
                document.getElementById('risk-level').className = "text-xl font-mono " + (risk > 10 ? 'text-danger' : (risk > 5 ? 'text-orange-400' : 'text-emerald-400'));
            } catch (e) { }
        }

        async function fetchActiveSlots() {
            try {
                const res = await fetch(`${API_BASE}/api/slots`);
                const slots = await res.json();
                const active = slots.filter(s => s.symbol);
                updateChartVisuals(active);

                document.getElementById('slots-header').innerHTML = `Active Deployments <span class="h-1 w-1 rounded-full bg-slate-500"></span> ${active.length} Assets`;

                const container = document.getElementById('slots-list');
                if (active.length === 0) {
                    container.innerHTML = `<div class="col-span-2 py-10 text-center opacity-30 uppercase font-bold text-[10px]">Sil√™ncio Radar: Aguardando Sinais</div>`;
                    return;
                }

                container.innerHTML = active.map(s => {
                    const pnl = s.pnl_percent || 0;
                    const pnlClass = pnl >= 0 ? 'text-emerald-400' : 'text-danger';

                    const side = (s.side || 'BUY').toUpperCase();
                    const entry = s.entry_price || 0;
                    const stop = s.current_stop || 0;
                    const isZeroRisk = side === 'BUY' ? (stop >= entry && stop > 0) : (stop <= entry && stop > 0);

                    const borderClass = isZeroRisk ? 'border-gold/50 shadow-[0_0_25px_rgba(255,215,0,0.15)] bg-gold/5' : 'border-white/5';
                    const sideClass = side === 'BUY' ? 'text-emerald-500' : 'text-danger';

                    // Mission Timer Calculation
                    const openedAt = s.opened_at || Date.now() / 1000;
                    const durationSec = Math.floor(Date.now() / 1000 - openedAt);
                    const mins = Math.floor(durationSec / 60);
                    const secs = durationSec % 60;
                    const timerStr = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                    // Momentum Gauge (Gas)
                    const momentum = s.cvd_momentum || 0;
                    const gasPercent = Math.min(100, Math.max(5, (Math.abs(momentum) / 50000) * 100));
                    const gasColor = momentum >= 0 ? 'bg-emerald-500' : 'bg-red-500';

                    return `
                        <div class="slot-card p-6 rounded-3xl border ${borderClass} flex flex-col gap-5 transition-all duration-500 single-order-mega relative overflow-hidden">
                            ${isZeroRisk ? '<div class="absolute top-0 right-0 px-3 py-1 risk-shield-badge text-[10px] font-black text-black rounded-bl-xl tracking-tighter shadow-lg">üõ°Ô∏è RISK ZERO SHIELD</div>' : ''}
                            
                            <!-- Header: Symbol and Vital Stats -->
                            <div class="flex justify-between items-start relative z-10">
                                <div class="space-y-1">
                                    <div class="flex items-center gap-3">
                                        <h4 class="font-black text-white text-2xl tracking-tighter">${s.symbol.replace('.P', '')}</h4>
                                        <div class="flex flex-col">
                                            <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Miss√£o</span>
                                            <span class="text-xs font-mono text-primary mission-timer">${timerStr}</span>
                                        </div>
                                    </div>
                                    <p class="text-[10px] font-black uppercase tracking-[0.2em] flex items-center gap-2 ${isZeroRisk ? 'text-gold' : 'text-primary/60'}">
                                        <span class="material-icons-round text-sm">${isZeroRisk ? 'verified_user' : 'gps_fixed'}</span>
                                        ${isZeroRisk ? 'OPERA√á√ÉO BLINDADA' : 'SNIPER ELITE V5.0'}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-black font-mono leading-none ${pnlClass}">
                                        ${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}<span class="text-lg opacity-60">%</span>
                                    </div>
                                    <div class="text-xs font-mono font-bold ${pnlClass} mt-1">
                                        ${pnl >= 0 ? '+' : ''}$${((pnl / 100) * (s.entry_margin || 0)).toFixed(2)} <span class="text-[9px] opacity-60 text-slate-500">USD</span>
                                    </div>
                                    <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mt-1">ROI Sniper</p>
                                </div>
                            </div>

                            <!-- Advanced Telemetry Grid -->
                            <div class="grid grid-cols-3 gap-3 py-4 border-y border-white/5 relative z-10">
                                <div>
                                    <p class="text-[8px] text-slate-500 uppercase font-black tracking-tighter mb-1">Entrada</p>
                                    <p class="text-xs font-mono text-slate-300 font-bold">$${entry.toLocaleString()}</p>
                                </div>
                                <div>
                                    <p class="text-[8px] text-slate-500 uppercase font-black tracking-tighter mb-1">Stop Loss</p>
                                    <p class="text-xs font-mono ${isZeroRisk ? 'text-gold font-black' : 'text-danger/80'}">$${stop.toLocaleString()}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-[8px] text-slate-500 uppercase font-black tracking-tighter mb-1">Dire√ß√£o</p>
                                    <span class="px-2 py-0.5 rounded-sm text-[9px] font-black ${sideClass} bg-white/5 border border-white/5 italic">${side} 50X</span>
                                </div>
                            </div>

                            <!-- Gas & Momentum -->
                            <div class="space-y-2 relative z-10">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <span class="material-icons-round text-[14px] text-primary animate-pulse">speed</span>
                                        <span class="text-[10px] text-slate-400 font-black uppercase tracking-widest">G√°s de Volatilidade</span>
                                    </div>
                                    <span class="text-[9px] font-mono text-slate-500">${Math.abs(momentum).toLocaleString(undefined, { maximumFractionDigits: 0 })} CVD</span>
                                </div>
                                <div class="gauge-container">
                                    <div class="gauge-fill ${gasColor}" style="width: ${gasPercent}%"></div>
                                </div>
                            </div>

                            <!-- Target Distance Bar -->
                            <div class="space-y-1.5 pt-1 relative z-10">
                                <div class="flex justify-between items-end">
                                    <span class="text-[9px] text-slate-500 font-black uppercase tracking-widest">Dist√¢ncia do Alvo</span>
                                    <span class="text-[10px] font-black text-primary">${Math.min(100, Math.max(0, pnl)).toFixed(0)}%</span>
                                </div>
                                <div class="w-full h-1.5 bg-white/5 rounded-full overflow-hidden border border-white/5">
                                    <div class="h-full bg-primary shadow-[0_0_15px_#00E0FF]" 
                                         style="width: ${Math.min(100, Math.max(5, pnl))}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) { }
        }

        function updateChartVisuals(activeSlots) {
            const lineEntry = document.getElementById('line-entry');
            const lineStop = document.getElementById('line-stop');
            const lineTarget = document.getElementById('line-target');

            const labelEntry = document.getElementById('label-entry');
            const labelStop = document.getElementById('label-stop');
            const labelTarget = document.getElementById('label-target');

            if (!activeSlots || activeSlots.length === 0) {
                // Default State (Scanning)
                labelEntry.textContent = "--";
                labelStop.textContent = "--";
                labelTarget.textContent = "--";
                // Default positions for aesthetics
                lineEntry.style.top = "50%";
                lineStop.style.top = "60%";
                lineTarget.style.top = "30%";
                return;
            }

            // Visualize the first active slot
            const s = activeSlots[0];
            const side = (s.side || "BUY").toUpperCase();
            const entry = parseFloat(s.entry_price || 0);
            const stop = parseFloat(s.current_stop || 0);
            let target = parseFloat(s.target_price || 0);

            // [V5.0] DYNAMIC POSITIONING ENGINE
            // If target is missing, use standard 2% movement (100% ROI @ 50x)
            if (target === 0 && entry > 0) {
                target = side === "BUY" ? entry * 1.02 : entry * 0.98;
            }

            labelEntry.textContent = entry.toLocaleString('en-US', { minimumFractionDigits: 2 });
            labelStop.textContent = stop.toLocaleString('en-US', { minimumFractionDigits: 2 });
            labelTarget.textContent = target.toLocaleString('en-US', { minimumFractionDigits: 2 });

            // Calculate vertical position based on percentage difference from entry
            // Logic: 1% price movement = 10% vertical height (visual unit)
            // Higher price = lower 'top' value (closer to top of screen)

            const stopDiffPct = ((stop - entry) / entry) * 100;
            const targetDiffPct = ((target - entry) / entry) * 100;

            // Base entry at 50%
            lineEntry.style.top = "50%";

            // Dynamic scale: 50% - (percent_diff * 10)
            // Example BUY: entry=100, stop=99 (-1%). top = 50 - (-1 * 10) = 60% (visually below)
            // Example BUY Risk-Zero: entry=100, stop=101 (+1%). top = 50 - (1 * 10) = 40% (visually above)
            lineStop.style.top = (50 - (stopDiffPct * 10)) + "%";
            lineTarget.style.top = (50 - (targetDiffPct * 10)) + "%";
        }

        // V9.0 Cycle Tracker Integration
        async function fetchCycleStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/vault/cycle`);
                if (!res.ok) return null;
                const cycle = await res.json();
                const cycleMini = document.getElementById('cycle-mini');
                if (cycleMini && cycle) {
                    const cycleNum = cycle.cycle_number || 1;
                    const usedSymbols = cycle.used_symbols_in_cycle || [];
                    const tradesCount = usedSymbols.length;
                    cycleMini.textContent = `C${cycleNum}: ${tradesCount}/10`;

                    // Color based on progress
                    if (tradesCount >= 8) {
                        cycleMini.className = 'text-[8px] sm:text-[10px] font-mono px-1.5 sm:px-2 py-0.5 rounded bg-green-500/10 text-green-400 border border-green-500/20';
                    } else if (tradesCount >= 5) {
                        cycleMini.className = 'text-[8px] sm:text-[10px] font-mono px-1.5 sm:px-2 py-0.5 rounded bg-primary/10 text-primary border border-primary/20';
                    } else {
                        cycleMini.className = 'text-[8px] sm:text-[10px] font-mono px-1.5 sm:px-2 py-0.5 rounded bg-gold/10 text-gold border border-gold/20';
                    }
                }
            } catch (e) {
                console.error('Error fetching cycle:', e);
            }
        }

        // Initial load and periodic updates
        document.addEventListener('DOMContentLoaded', () => {
            fetchCycleStatus();
            setInterval(fetchCycleStatus, 15000); // Refresh every 15s
        });
    </script>
</body>

</html>