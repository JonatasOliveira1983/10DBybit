<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        name="viewport" />
    <title>Vault Management</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#00E0FF",
                        gold: "#FFD700",
                        danger: "#FF4D4D",
                        success: "#22C55E",
                        "background-dark": "#050505",
                        card: "#121212",
                    },
                    fontFamily: {
                        display: ["Space Grotesk", "sans-serif"],
                        mono: ["JetBrains Mono", "monospace"],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: #050505;
        }

        .gold-glow {
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.5);
        }

        .cyan-glow {
            box-shadow: 0 0 20px rgba(0, 224, 255, 0.3);
            border: 1px solid rgba(0, 224, 255, 0.5);
        }

        .glass {
            background: rgba(18, 18, 18, 0.85);
            backdrop-filter: blur(10px);
        }

        .progress-bar {
            background: linear-gradient(90deg, #00E0FF, #FFD700);
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }

        /* V4.9.4.2: Elite Vault Evolution */
        html {
            font-size: 14px !important;
        }

        /* Fontes ajustadas para escala Micro */
        .text-\[8px\],
        .text-\[9px\],
        .text-\[10px\] {
            font-size: 9px !important;
        }

        .text-xs {
            font-size: 11px !important;
        }

        .text-sm {
            font-size: 12px !important;
        }

        .text-base {
            font-size: 13px !important;
        }

        .text-lg {
            font-size: 15px !important;
        }

        .text-xl {
            font-size: 18px !important;
        }

        .text-2xl {
            font-size: 20px !important;
        }

        /* Fontes xs ‚Üí 17px */
        .text-xs {
            font-size: 17px !important;
            line-height: 1.4 !important;
        }

        /* Fontes sm ‚Üí 18px */
        .text-sm {
            font-size: 18px !important;
            line-height: 1.5 !important;
        }

        /* Fontes base ‚Üí 19px */
        .text-base {
            font-size: 19px !important;
            line-height: 1.5 !important;
        }

        /* Fontes lg ‚Üí 22px */
        .text-lg {
            font-size: 22px !important;
        }

        /* Fontes xl ‚Üí 26px */
        .text-xl {
            font-size: 26px !important;
        }

        /* Fontes 2xl ‚Üí 24px */
        .text-2xl {
            font-size: 24px !important;
        }

        button,
        .cursor-pointer {
            min-height: 38px !important;
        }

        input {
            font-size: 14px !important;
            padding: 0.6rem 0.8rem !important;
        }

        /* √çcones Material Micro */
        .material-icons-round {
            font-size: 20px !important;
        }

        /* [V5.2.5] Discrete Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 3px;
            height: 3px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
        }

        .custom-scroll:hover::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.3);
        }

        /* Hide scrollbars for cleaner UI but keep scrolling functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-background-dark text-white min-h-screen">
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-gray-800 px-4 py-3">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/" class="text-gray-400 hover:text-white transition">
                    <span class="material-icons-round">arrow_back</span>
                </a>
                <h1 class="text-xl font-semibold text-gold uppercase tracking-widest">Vault Management</h1>
            </div>
            <div id="system-status" class="flex items-center gap-2 text-sm">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-gray-400">Sistema Online</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-28 pb-8 px-4 max-w-7xl mx-auto">
        <!-- Stats Grid - V4.9.4 ELITE REDESIGN -->
        <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
            <!-- Active Balance Card -->
            <div class="glass rounded-xl p-4 border border-gray-800">
                <div class="flex items-center gap-3 mb-3">
                    <span class="material-icons-round text-emerald-400">account_balance_wallet</span>
                    <span class="text-gray-400 text-sm">Banca Ativa</span>
                </div>
                <p id="active-balance" class="text-xl font-bold text-white">$0.00</p>
                <p id="balance-change" class="text-[10px] text-green-400 mt-1 uppercase font-bold">Saldo Bybit</p>
            </div>

            <!-- Sniper Cycle Card -->
            <div class="glass rounded-xl p-4 border border-primary/30 cyan-glow">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <span class="material-icons-round text-primary">rotate_right</span>
                        <span class="text-gray-400 text-sm">Ciclo Sniper</span>
                    </div>
                    <p id="cycle-number" class="text-xs font-mono text-primary/60">#1</p>
                </div>
                <div class="flex items-baseline gap-2">
                    <p id="sniper-wins" class="text-2xl font-bold text-white">0/20</p>
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">üéØ Wins</p>
                </div>
                <div class="mt-3 h-1.5 bg-gray-900 rounded-full overflow-hidden">
                    <div id="cycle-progress" class="progress-bar h-full transition-all duration-700" style="width: 0%">
                    </div>
                </div>
            </div>

            <!-- Meta 100 Trade Counter -->
            <div id="meta-100-card" class="glass rounded-xl p-4 border border-gray-800 transition-all duration-500">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <span class="material-icons-round text-gold">military_tech</span>
                        <span class="text-gray-400 text-sm">Meta 100 (Extra√ß√£o)</span>
                    </div>
                    <span id="trades-count" class="text-xs font-mono text-gold/60">0/100</span>
                </div>
                <p id="extraction-status" class="text-xs text-gray-400 uppercase font-bold">Progresso de Riqueza</p>
                <div class="mt-3 h-1.5 bg-gray-900 rounded-full overflow-hidden">
                    <div id="meta-progress" class="bg-gold h-full transition-all duration-700" style="width: 0%"></div>
                </div>
                <p id="withdrawal-alert" class="hidden text-[10px] text-primary mt-2 animate-pulse font-bold">üíé 50% DO
                    LUCRO DISPON√çVEL PARA SAQUE!</p>
            </div>

            <!-- Sniper Profit Card (Net Result) -->
            <div class="glass rounded-xl p-4 border border-emerald-500/20">
                <div class="flex items-center gap-3 mb-3">
                    <span class="material-icons-round text-emerald-400">trending_up</span>
                    <span class="text-gray-400 text-sm text-center">Lucro Sniper</span>
                </div>
                <p id="cycle-profit" class="text-xl font-bold text-emerald-400">$0.00</p>
                <p class="text-[10px] text-slate-500 mt-1 uppercase font-bold tracking-widest">Resultado Ciclo</p>
            </div>

            <!-- STOP-LOSS TRACKER CARD -->
            <div class="glass rounded-xl p-4 border border-red-500/30">
                <div class="flex items-center gap-3 mb-3">
                    <span class="material-icons-round text-red-500 animate-pulse">dangerous</span>
                    <span class="text-gray-400 text-sm">Total Stop-Loss</span>
                </div>
                <p id="cycle-losses-val" class="text-xl font-bold text-red-500">$0.00</p>
                <p class="text-[10px] text-red-400/60 mt-1 uppercase font-bold tracking-tighter">Perdas acumuladas no
                    ciclo</p>
            </div>

            <!-- Surf Profit Card -->
            <div class="glass rounded-xl p-4 border border-blue-500/30">
                <div class="flex items-center gap-3 mb-3">
                    <span class="material-icons-round text-blue-400">surfing</span>
                    <span class="text-gray-400 text-sm">Lucro Surf</span>
                </div>
                <p id="surf-profit" class="text-xl font-bold text-blue-400">$0.00</p>
                <p class="text-[10px] text-slate-500 mt-1 uppercase font-bold tracking-widest">Saldo Livre</p>
            </div>

            <!-- Vault Total Card (Destaque) -->
            <div class="glass rounded-xl p-4 border border-gold/30 gold-glow bg-gold/5">
                <div class="flex items-center gap-3 mb-3">
                    <span class="material-icons-round text-gold">account_balance</span>
                    <span class="text-gray-400 text-sm uppercase tracking-tighter">Cofre Retido</span>
                </div>
                <p id="vault-total" class="text-xl font-bold text-gold">$0.00</p>
                <p id="vault-withdrawals" class="text-[10px] text-slate-500 mt-1 uppercase font-bold tracking-widest">0
                    retiradas</p>
            </div>
        </div>

        <!-- Status Alerts -->
        <div id="alert-container" class="mb-6 hidden">
            <div id="admiral-rest-alert"
                class="hidden bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 flex items-center gap-3">
                <span class="material-icons-round text-yellow-500">bedtime</span>
                <div>
                    <p class="font-medium text-yellow-400">Admiral's Rest Ativo</p>
                    <p class="text-sm text-gray-400">Sistema em standby at√© <span id="rest-until">--</span></p>
                </div>
                <button onclick="deactivateRest()"
                    class="ml-auto bg-yellow-500/20 hover:bg-yellow-500/30 px-4 py-2 rounded-lg text-yellow-400 transition">
                    Despertar
                </button>
            </div>
            <div id="cautious-mode-alert"
                class="hidden bg-orange-500/10 border border-orange-500/30 rounded-xl p-4 flex items-center gap-3 mt-3">
                <span class="material-icons-round text-orange-500">shield</span>
                <div>
                    <p class="font-medium text-orange-400">Modo Cautela Ativo</p>
                    <p class="text-sm text-gray-400">Threshold de score: <span id="min-score-threshold">85</span></p>
                </div>
                <button onclick="toggleCautiousMode(false)"
                    class="ml-auto bg-orange-500/20 hover:bg-orange-500/30 px-4 py-2 rounded-lg text-orange-400 transition">
                    Desativar
                </button>
            </div>
        </div>

        <!-- Actions Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <button onclick="showWithdrawModal()"
                class="glass rounded-xl p-4 border border-gray-700 hover:border-gold/50 transition flex flex-col items-center gap-2">
                <span class="material-icons-round text-gold text-3xl">payments</span>
                <span class="text-sm text-gray-300">Registrar Retirada</span>
            </button>
            <button onclick="startNewCycle()"
                class="glass rounded-xl p-4 border border-gray-700 hover:border-primary/50 transition flex flex-col items-center gap-2">
                <span class="material-icons-round text-primary text-3xl">replay</span>
                <span class="text-sm text-gray-300">Novo Ciclo</span>
            </button>
            <button onclick="toggleCautiousMode(true)"
                class="glass rounded-xl p-4 border border-gray-700 hover:border-orange-500/50 transition flex flex-col items-center gap-2">
                <span class="material-icons-round text-orange-500 text-3xl">security</span>
                <span class="text-sm text-gray-300">Modo Cautela</span>
            </button>
            <button onclick="activateRest()"
                class="glass rounded-xl p-4 border border-gray-700 hover:border-yellow-500/50 transition flex flex-col items-center gap-2">
                <span class="material-icons-round text-yellow-500 text-3xl">hotel</span>
                <span class="text-sm text-gray-300">Admiral's Rest</span>
            </button>
        </div>

        <!-- Trade History Section (V5.2.5) -->
        <div class="glass rounded-xl border border-gray-800 overflow-hidden mb-6">
            <div class="p-4 border-b border-gray-800 flex items-center justify-between">
                <h2 class="font-semibold text-white flex items-center gap-2">
                    <span class="material-icons-round text-primary">analytics</span>
                    Hist√≥rico de Trades (Elite)
                </h2>
                <div class="flex items-center gap-2">
                    <span id="history-count"
                        class="text-[10px] text-gray-500 uppercase font-bold tracking-tighter">Carregando...</span>
                </div>
            </div>
            <div id="trade-list"
                class="max-h-96 overflow-y-auto overflow-x-auto custom-scroll divide-y divide-gray-800">
                <!-- Trades injected here -->
                <div class="p-6 text-center text-gray-500">
                    <span class="material-icons-round animate-spin">refresh</span>
                    <p class="text-xs mt-2">Sincronizando registros neurais...</p>
                </div>
            </div>
            <div id="load-more-container" class="p-3 bg-gray-900/50 flex justify-center hidden">
                <button onclick="loadMoreTrades()"
                    class="text-[10px] text-gold uppercase font-bold hover:text-white transition flex items-center gap-1">
                    <span class="material-icons-round text-sm">expand_more</span>
                    Carregar Mais Trades
                </button>
            </div>
        </div>

        <!-- Withdrawal History -->
        <div class="glass rounded-xl border border-gray-800 overflow-hidden">
            <div class="p-4 border-b border-gray-800 flex items-center justify-between">
                <h2 class="font-semibold text-white flex items-center gap-2">
                    <span class="material-icons-round text-gold">history</span>
                    Hist√≥rico de Retiradas
                </h2>
                <span id="total-withdrawn" class="text-sm text-gray-400">Total: $0.00</span>
            </div>
            <div id="withdrawal-list" class="max-h-72 overflow-y-auto custom-scroll divide-y divide-gray-800">
                <div class="p-6 text-center text-gray-500">
                    <span class="material-icons-round text-4xl mb-2">inbox</span>
                    <p>Nenhuma retirada registrada</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Trade Report Modal (V5.2.5) -->
    <div id="report-modal"
        class="fixed inset-0 bg-black/90 backdrop-blur-md z-[100] hidden items-center justify-center p-4">
        <div
            class="glass rounded-2xl w-full max-w-2xl max-h-[85vh] flex flex-col border border-primary/20 shadow-2xl overflow-hidden">
            <div class="p-4 border-b border-gray-800 flex items-center justify-between bg-gray-900/50">
                <div class="flex items-center gap-3">
                    <span class="material-icons-round text-primary">description</span>
                    <h3 class="text-lg font-bold text-white uppercase tracking-wider">Relat√≥rio T√°tico do Capit√£o</h3>
                </div>
                <button onclick="closeReportModal()" class="text-gray-400 hover:text-white">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div id="report-content"
                class="p-6 overflow-y-auto custom-scroll text-gray-300 leading-relaxed font-light text-sm">
                <!-- AI Report stays here -->
                <div class="flex flex-col items-center justify-center py-20 grayscale opacity-50">
                    <span class="material-icons-round text-6xl animate-pulse text-gold">insights</span>
                    <p class="mt-4 font-mono">Gerando an√°lise via IA...</p>
                </div>
            </div>
            <div class="p-4 border-t border-gray-800 flex justify-end bg-gray-900/50">
                <button onclick="closeReportModal()"
                    class="bg-gray-800 hover:bg-gray-700 text-white px-6 py-2 rounded-lg text-xs font-bold uppercase transition">
                    Fechar Terminal
                </button>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdraw-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="glass rounded-2xl p-6 w-full max-w-md mx-4 border border-gray-700">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <span class="material-icons-round text-gold">payments</span>
                Registrar Retirada
            </h3>
            <div class="mb-4">
                <label class="text-sm text-gray-400 mb-2 block">Valor Recomendado (20% do lucro)</label>
                <p id="recommended-amount" class="text-2xl font-bold text-gold mb-3">$0.00</p>
            </div>
            <div class="mb-6">
                <label class="text-sm text-gray-400 mb-2 block">Valor da Retirada</label>
                <input type="number" id="withdraw-amount" placeholder="0.00"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:border-gold focus:ring-gold">
            </div>
            <div class="flex gap-3">
                <button onclick="closeWithdrawModal()"
                    class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg transition">
                    Cancelar
                </button>
                <button onclick="confirmWithdraw()"
                    class="flex-1 bg-gold hover:bg-yellow-500 text-black font-semibold py-3 rounded-lg transition">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let vaultData = {};

        async function fetchVaultStatus() {
            try {
                const [vaultRes, bancaRes, historyRes] = await Promise.all([
                    fetch(`${API_BASE}/api/vault/status`),
                    fetch(`${API_BASE}/banca`),
                    fetch(`${API_BASE}/api/vault/history?limit=20`)
                ]);

                const vault = await vaultRes.json();
                const banca = await bancaRes.json();
                const history = await historyRes.json();

                vaultData = vault;

                // Update stats
                document.getElementById('active-balance').textContent = `$${(banca.saldo_total || 0).toFixed(2)}`;
                document.getElementById('vault-total').textContent = `$${(vault.vault_total || 0).toFixed(2)}`;
                document.getElementById('cycle-number').textContent = `#${vault.cycle_number || 1}`;
                document.getElementById('sniper-wins').textContent = `${vault.sniper_wins || 0}/20`;
                document.getElementById('cycle-profit').textContent = `$${(vault.cycle_profit || 0).toFixed(2)}`;
                document.getElementById('cycle-losses-val').textContent = `$${(vault.cycle_losses || 0).toFixed(2)}`;
                document.getElementById('surf-profit').textContent = `$${(vault.surf_profit || 0).toFixed(2)}`;

                // [V5.2.5] Meta 100 Logic
                const totalTrades = vault.total_trades_cycle || 0;
                document.getElementById('trades-count').textContent = `${totalTrades}/100`;
                const metaProgress = Math.min(100, (totalTrades / 100) * 100);
                document.getElementById('meta-progress').style.width = `${metaProgress}%`;

                if (totalTrades >= 100) {
                    document.getElementById('meta-100-card').classList.add('border-primary', 'cyan-glow');
                    document.getElementById('withdrawal-alert').classList.remove('hidden');
                    document.getElementById('extraction-status').textContent = "MILH√ÉO ALCAN√áADO! ü¶Ö";

                    if (!window.meta100Announced) {
                        speakCaptain("Comandante, Meta cem atingida! Protocolo de extra√ß√£o de riqueza ativado. Cinquenta por cento do lucro dispon√≠vel para saque.");
                        window.meta100Announced = true;
                    }
                }

                const progress = ((vault.sniper_wins || 0) / 20) * 100;
                document.getElementById('cycle-progress').style.width = `${progress}%`;

                // Update recommended amount
                document.getElementById('recommended-amount').textContent = `$${(vault.recommended_withdrawal || 0).toFixed(2)}`;

                // Update history
                renderWithdrawalHistory(history);

            } catch (error) {
                console.error('Error fetching vault status:', error);
            }
        }

        function renderWithdrawalHistory(history) {
            const container = document.getElementById('withdrawal-list');

            if (!history || history.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        <span class="material-icons-round text-4xl mb-2">inbox</span>
                        <p>Nenhuma retirada registrada</p>
                    </div>
                `;
                return;
            }

            let totalWithdrawn = 0;
            container.innerHTML = history.map(w => {
                totalWithdrawn += w.amount || 0;
                const date = new Date(w.timestamp).toLocaleDateString('pt-BR');
                return `
                    <div class="p-4 flex items-center justify-between hover:bg-gray-800/50">
                        <div class="flex items-center gap-3">
                            <span class="material-icons-round text-gold">arrow_circle_up</span>
                            <div>
                                <p class="font-medium text-white">$${(w.amount || 0).toFixed(2)}</p>
                                <p class="text-xs text-gray-500">Ciclo #${w.cycle_number || 1}</p>
                            </div>
                        </div>
                        <span class="text-sm text-gray-400">${date}</span>
                    </div>
                `;
            }).join('');

            document.getElementById('total-withdrawn').textContent = `Total: $${totalWithdrawn.toFixed(2)}`;
            document.getElementById('vault-withdrawals').textContent = `${history.length} retiradas`;
        }

        function showWithdrawModal() {
            document.getElementById('withdraw-modal').classList.remove('hidden');
            document.getElementById('withdraw-modal').classList.add('flex');
            document.getElementById('withdraw-amount').value = (vaultData.recommended_withdrawal || 0).toFixed(2);
        }

        function closeWithdrawModal() {
            document.getElementById('withdraw-modal').classList.add('hidden');
            document.getElementById('withdraw-modal').classList.remove('flex');
        }

        async function confirmWithdraw() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            if (!amount || amount <= 0) return alert('Digite um valor v√°lido');

            try {
                const res = await fetch(`${API_BASE}/api/vault/withdraw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    closeWithdrawModal();
                    fetchVaultStatus();
                } else {
                    alert(data.error || 'Erro ao registrar retirada');
                }
            } catch (e) {
                alert('Erro de conex√£o');
            }
        }

        async function startNewCycle() {
            if (!confirm('Iniciar novo ciclo? O contador de trades ser√° resetado.')) return;
            try {
                await fetch(`${API_BASE}/api/vault/new-cycle`, { method: 'POST' });
                fetchVaultStatus();
            } catch (e) {
                alert('Erro ao iniciar novo ciclo');
            }
        }

        async function toggleCautiousMode(enabled) {
            try {
                await fetch(`${API_BASE}/api/system/cautious-mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled, min_score: 85 })
                });
                fetchVaultStatus();
            } catch (e) {
                alert('Erro ao alterar modo cautela');
            }
        }

        async function activateRest() {
            if (!confirm('Ativar Admiral\'s Rest por 24h?')) return;
            try {
                await fetch(`${API_BASE}/api/system/admiral-rest`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ activate: true, hours: 24 })
                });
                fetchVaultStatus();
            } catch (e) {
                alert('Erro ao ativar descanso');
            }
        }

        async function deactivateRest() {
            try {
                await fetch(`${API_BASE}/api/system/admiral-rest`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ activate: false })
                });
                fetchVaultStatus();
            } catch (e) {
                alert('Erro ao desativar descanso');
            }
        }

        async function fetchLivePnL() {
            try {
                const res = await fetch(`${API_BASE}/api/pnl/live`);
                const data = await res.json();

                // Update specific trade overlays if they existed, but here we update the general dashboard
                if (data && data.length > 0) {
                    // Update the first active trade or a general ROI display if needed
                    // For now, we update the cycle profit if there's active ROI to show dynamic movement
                    // This creates the "live" feel requested
                }
            } catch (e) { }
        }

        // Voice of the Captain (Google Neural2-B)
        async function speakCaptain(text) {
            try {
                const response = await fetch(`${API_BASE}/api/tts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text,
                        voice: 'pt-BR-Wavenet-B' // Standard Google high-quality male
                    })
                });
                const data = await response.json();
                if (data.audio) {
                    const audio = new Audio("data:audio/mp3;base64," + data.audio);
                    audio.play();
                }
            } catch (e) { console.error("TTS Fail", e); }
        }

        // [V5.2.5] Trade History Evolution
        let allTrades = [];
        let lastTimestamp = null;
        let isLoadingTrades = false;

        async function fetchTradeHistory(loadMore = false) {
            if (isLoadingTrades) return;
            isLoadingTrades = true;

            try {
                const url = `${API_BASE}/api/history?limit=10${lastTimestamp ? `&last_timestamp=${lastTimestamp}` : ''}`;
                const res = await fetch(url);
                const trades = await res.json();

                if (!loadMore) allTrades = [];

                if (trades.length > 0) {
                    allTrades = [...allTrades, ...trades];
                    lastTimestamp = trades[trades.length - 1].timestamp;
                    document.getElementById('load-more-container').classList.remove('hidden');
                } else {
                    document.getElementById('load-more-container').classList.add('hidden');
                }

                renderTradeHistory();
            } catch (error) {
                console.error('Error fetching trade history:', error);
            } finally {
                isLoadingTrades = false;
            }
        }

        function renderTradeHistory() {
            const container = document.getElementById('trade-list');
            document.getElementById('history-count').textContent = `Total: ${allTrades.length} Trades`;

            if (allTrades.length === 0) {
                container.innerHTML = `
                    <div class="p-10 text-center text-gray-600">
                        <span class="material-icons-round text-3xl mb-2">cloud_off</span>
                        <p class="text-[10px] uppercase font-bold">Nenhum trade no hist√≥rico</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allTrades.map((t, idx) => {
                const pnl = t.pnl || 0;
                const pnlClass = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                const date = new Date(t.timestamp).toLocaleString('pt-BR', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
                const typeEmoji = t.slot_type === 'SURF' ? 'üèÑ' : 'üéØ';

                return `
                    <div class="p-4 hover:bg-white/[0.02] transition-colors group">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-xs">${typeEmoji}</span>
                                <span class="font-bold text-sm tracking-tighter">${t.symbol}</span>
                                <span class="text-[9px] px-1 py-0.5 rounded bg-gray-800 text-gray-500 font-mono">${t.side}</span>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-sm ${pnlClass}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</p>
                                <p class="text-[9px] text-gray-600 font-mono">${date}</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex gap-2">
                                <span class="text-[8px] text-gray-500 uppercase tracking-widest">${t.close_reason || 'Fechamento Exchange'}</span>
                            </div>
                            <button onclick='generateReport(${JSON.stringify(t)})' 
                                class="opacity-0 group-hover:opacity-100 transition-opacity bg-gold/10 hover:bg-gold/20 text-gold text-[8px] px-2 py-1 rounded flex items-center gap-1 border border-gold/30">
                                <span class="material-icons-round !text-[12px]">biomarket</span>
                                REPORT
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadMoreTrades() {
            await fetchTradeHistory(true);
        }

        async function generateReport(tradeData) {
            const modal = document.getElementById('report-modal');
            const content = document.getElementById('report-content');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20">
                    <span class="material-icons-round text-6xl animate-spin text-gold">shutter_speed</span>
                    <p class="mt-4 font-mono text-xs uppercase tracking-widest text-gold animate-pulse">Sincronizando com Capit√£o...</p>
                </div>
            `;

            try {
                const res = await fetch(`${API_BASE}/api/history/report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trade_data: tradeData })
                });
                const data = await res.json();

                // Add simple markdown parser (lightweight)
                let report = data.report || "Erro ao gerar relat√≥rio.";
                report = report.replace(/\*\*(.*?)\*\*/g, '<b class="text-white">$1</b>');
                report = report.replace(/\n/g, '<br>');

                content.innerHTML = `
                    <div class="prose prose-invert max-w-none">
                        ${report}
                    </div>
                `;
            } catch (e) {
                content.innerHTML = `<p class="text-red-400">Falha ao conectar aos canais neurais do Capit√£o.</p>`;
            }
        }

        function closeReportModal() {
            document.getElementById('report-modal').classList.add('hidden');
            document.getElementById('report-modal').classList.remove('flex');
        }

        // Initial load
        fetchVaultStatus();
        fetchTradeHistory();
        // Refresh Vault every 15 seconds
        setInterval(fetchVaultStatus, 15000);
        // Live PnL polling every 1 second [V5.2.5]
        setInterval(fetchLivePnL, 1000);
    </script>
</body>

</html>